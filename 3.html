<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Exemplo de Streaming com MSE e Blob</title>
    <style>
        body { font-family: sans-serif; text-align: center; }
        video { border: 2px solid #ccc; max-width: 800px; }
    </style>
</head>
<body>
    <h1>Exemplo de Streaming de Vídeo com MSE e `Blob`</h1>
    <p>Este exemplo carrega e reproduz o vídeo de 3 partes usando `Media Source Extensions` (MSE).</p>
    <video id="videoPlayer" controls autoplay></video>

    <script>
        // Verifica se o navegador suporta Media Source Extensions
        if ('MediaSource' in window && window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')) {
            const video = document.getElementById('videoPlayer');
            const mediaSource = new MediaSource();
            video.src = URL.createObjectURL(mediaSource);

            mediaSource.addEventListener('sourceopen', () => {
                console.log('MediaSource está aberto. Criando SourceBuffer...');

                // Cria um SourceBuffer. O tipo e codecs precisam ser corretos.
                const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E, mp4a.40.2"');
              const videoParts = ['parte-1.bin', 'parte-2.bin', 'parte-3.bin'];
let partIndex = 0;

// Função para processar a próxima parte
function processNextPart() {
    if (partIndex < videoParts.length) {
        const part = videoParts[partIndex];
        console.log(`Buscando e anexando a parte ${part}...`);

        fetch(part)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => {
                sourceBuffer.appendBuffer(arrayBuffer);
                // Aumenta o índice apenas após o appendBuffer
                partIndex++;
            })
            .catch(error => {
                console.error(`Erro ao carregar a parte ${part}:`, error);
                mediaSource.endOfStream("network-error"); // Finaliza a stream em caso de erro
            });
    } else {
        // Todas as partes processadas, pode finalizar a stream
        if (!mediaSource.isStreamEnded) {
            mediaSource.endOfStream();
            console.log('Fim do streaming.');
        }
    }
}

// O ponto crucial: só chame a próxima parte quando a anterior terminar
sourceBuffer.addEventListener('updateend', () => {
    // Verifica se há mais partes para processar
    if (partIndex < videoParts.length) {
        processNextPart();
    }
});

// Inicia o processo com a primeira parte
processNextPart();
            }, { once: true });

        } else {
            // Mensagem de erro caso o navegador não suporte MSE
            console.error("Seu navegador não suporta Media Source Extensions para este tipo de vídeo.");
            const video = document.getElementById('videoPlayer');
            video.innerHTML = "<p>Seu navegador não suporta a tecnologia necessária para este exemplo.</p>";
        }
    </script>
</body>
</html>
